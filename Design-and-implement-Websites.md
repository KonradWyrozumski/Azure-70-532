# 1. Deploy websites 
	
* 4 deployment slots + one production
* Setting for deployment slots:
		
 Setting name	 							|	Swap?
--------------------------------------------|------
General settings 							|	yes
Connection string 							|	yes
Connection string 							|	yes
Handler mapping	 							|	yes
Application and site diagnostics settings	| 	yes
Monitoring settings							| 	yes
Publishing endpoints						|	no
Custom domain names							| 	no
SSL certificates and bindings				|	no
Scale settings								| 	no

* Web Hosting plan can only be created during creating new website
* Web hosting plan must share the same:
	* Subscription
	* Resource group
	* Region
	* Pricing tier
	
# 2. Configure websites

## Configuration values
* In .NET apps connection strings, app settings are used like always
* In Python, Node Js, PHP, Java they are environment variables
* Connection string has got connection type
* Values for connection strings are not displayed by default
* Prefixes:
		
Connection prefix 	| Database name
--------------------|--------------
SQLAZURECONNSTR_	|	SQL Database
SQLCONNSTR_			|	SQL Server
MYSQLCONNSTR_		|	MySQL
CUSTOM_CONNSTR_ 	|	Custom
	
* Handlers mapping instruct websites how to handle requests for files. For example when configured the request does not get into ASP.NET
* Handlers mapping are configured in website configuration
* They require absolute path to handler

* Virtual directories are to expose deeply folders as much shorter
* Allows to create multiple web applications inside one website by configuring folders as virtual directories
* Configured in website configuration

## Custom domains
* Two types of DNS records:
	* A record - map domain name to IP address
	* CNAME - map subdomain of domain name to canonical name
* A record requires adding CNAME with awverify.<yourwebsite>.azurewebsites.net (in domain registrar), then A record (in domain registrar) and register in Domain Names list (in Azure portal)
* IP address may change if your page goes to Free plan, if you recreate it or if you enable SSL with the IP-based type

## Certificates
* Custom certificates not available in Shared mode
* Single fully qualified domain name - basic certs
* List of fully qualified domain names - subjectAltName or UC certs
* Across unlimited subdomains - wildcard certs
* You can use build-in certificate (automatically available) or your own
* Wildcard certs are not recommended due to:
	* Phishing attacks - cert still valid for a mock website in Azure portal
	* Private key compromise - someone who can get private key can also decrypt all traffic across Azure Websites
* Custom certificate requires custom domain setup
* Requirements for certificate:
	* Must contain both private and public key
	* Created for key exchange, exportable to *.pfx
	* Subject name must match the domain name
	* Needs to use 2,048-bit encryption minimum
* If using A record, you need to update IP address after assigning certificate
* SNI - Server name Indication - allows to host multiple certificates at single web server host accessed using a single IP address shared among websites, multiple domains using multiple certificates all hosted on single IP address

# 3. Configure diagnostics, monitoring and analytics
* Event log - equivalent of Windows Event Log - useful for unhandled exception. One XML file per site. \LogFiles\eventlog.xml
* Web Server Logs - text entry for each HTTP request - \LogFiles\http\RawLogs\*.log
* Detailed error message logs - generated by web server with failed requests resulting in HTTP code 400 or higher. One per HTML file - \LogFiles\DetailedErrors\ErrorPage####.html
* Addition to error messages above, stack trace in XML - \LogFiles]W3SVC*\*.xml
* Application diagnostics logs - for .NET logs created by Trace class - LogFiles\Application\*.txt

## Getting logs using
* Powershell - GetAzureWebsiteLog -Name <websiteName> -Tail
* Azure CLI - azure site log downloads; azure site tail
* FTP - you need to set deployment credentials first

## Application Diagnostics logging
* Table and Blobs are available only to .NET applications
* Event log is always enabled

## Remote Debugging
* Code needs to be deployed with Debug symbols
	
## Endpoint monitoring
* Allows to leverage a service remote to your website to ping it (possibly from multiple locations)
* Available only in Standard mode
* Once setup is possible to use in alerts

## Alerts
* Possible values to measure:
	* Memory
	* CPU
	* Data
	* HTTP status

# 4. WebJobs
* Can be written in multiple languages
* Running jobs within the context of Azure Website that allows background processing
* Can run on demand, continuously, on schedule
* WebJobs operations can run when job runs or when a new file is created in Blob storage, or message comes to Azure queue
	
Trigger name | Use 
-------------|-----
BlobTrigger	 | trigger for blobs
QueueTrigger | trigger for queue
Blob		 | allow access to particular blob. Can be used with Write access
Queue		 | allow access to particular queue. Can add new message to queue
	
* WebJobs do not support 1-second recur timer

# 5. Configure websites for scale and resilience
* Azure allows to scale number of instances (scale out and in) and by adjusting instance size (scale up and down)
* Changing instance size allowed in Basic and Standard mode
*  Scale out where available?
* Websites has got 99.9 SLA without anything more to provision
* Allowed in Standard mode
* You can auto scale by schedule (in existing portal, not available in preview yet)
* Auto scale by metrics used for scale out and in based on average for all instances of:
	* CPU (only one metric supported in existing portal)
	* Memory percentage
	* Disk Queue Length
	* Http Queue Length
	* Data in
	* Data out
* Auto scale by metrics is available in both portals
* Auto scale/changing instance size affects instance count of hosting plan, not individual website

## Traffic Manager
* Only in existing portal
* Combines endpoint monitoring with DNS so that client is directed toward a viable endpoint
* Traffic does not flow through traffic manager, but it's rather a result of DNS resolution
* TTL - cache time in browser to prevent DNS resolution on every request. Default 300 seconds
* You can use TM only for subdomains, not domains
* TM has got three load balancing methods:
	* Failover - picks first endpoint from ordered list that is healthy
	* Round robin - tries evenly distribute traffic among endpoints
	* Performance - picks the closest endpoint. TM maintains lookup table  (Internet Latency Table) of DNS server IP address range and for each IP range collects the round-trip latency from servers in that range to datacenter region. Once all endpoints from closest datacenter are not available it switches to round-robin
* All load balancing methods has got failover feature

# 6. Design and implement applications for scale and resilience
* Resiliency is ability of application to recover after some form of failure

## Throttling pattern
* Returns 503 HTTP status code to client
* Quickly responds to increased load by restricting the consumption of resource
* This could be outright request rejection, switching to lower streaming rate, focus on high priority requests
* Often paired with auto-scale, as it is not instantaneous

## Retry pattern
* When application experience short-lived temporary failures, it should transparently try to retry the failed operation
* Most common example is connection to overloaded SQL database
* Application should retry multiple times and back off

## Circuit breaker
* Acts like a proxy from the client to your service when invoking operations that may fail, particularly when failure is long lasting
* When everything is OK, circuit breaker is in closed state
* When number of failures increase to some threshold value, it switches to open state (returns immediately error without actual attempt to call service)
* After cool down timer expires it switches to half-open state, where some requests invoke actual service and some fail immediately

* Implementation of fault handling requires special way how your code invoke the operations on the service
* Azure SQL Database, Azure Storage already implements this in client library
* For other services requires client to work with Transient Fault Handling Application Block - NuGet search "topaz"

## ARR affinity (application request routing)
* Feature of websites that allows sticky sessions between client and website instance using cookie
* Useful once a lot of state is loaded into memory for any given client and moving this state between instance is costly 
* It limits scalability